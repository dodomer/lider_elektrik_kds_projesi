<!DOCTYPE html>
<html lang="tr">
<head>
<script>
  (function () {
    const isLoggedIn = sessionStorage.getItem('liderElektrikLoggedIn');

    if (isLoggedIn !== 'true') {
      // Eski localStorage kaydÄ± falan varsa yine de gÃ¼venme, temizle
      localStorage.removeItem('liderElektrikLoggedIn');  
      // GiriÅŸ yapÄ±lmamÄ±ÅŸsa login sayfasÄ±na yÃ¶nlendir
      window.location.href = '/login.html';
    }
  })();
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lider Elektrik â€“ Depo Karar Destek Sistemi</title>
    
    <!-- Google Fonts - Distinctive typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <button class="logo" id="logo-home-btn" type="button" title="Ana Ekrana DÃ¶n">
                <span class="logo-icon">âš¡</span>
                <div class="logo-text">
                    <h1>Lider Elektrik</h1>
                    <span class="logo-subtitle">Karar Destek Sistemi</span>
                </div>
            </button>
            <nav class="header-nav">
                <button class="header-link" id="btn-product-analytics">
                    <span class="header-link-icon">ğŸ“Š</span>
                    ÃœrÃ¼n Analizleri
                </button>
                <button class="header-link" id="btn-all-products">
                    <span class="header-link-icon">ğŸ“‹</span>
                    TÃ¼m ÃœrÃ¼nler
                </button>
                <button class="logout-btn" onclick="logout()">
                    <span class="logout-icon">â»</span>
                    <span class="logout-label">Ã‡Ä±kÄ±ÅŸ Yap</span>
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- ==================== -->
        <!-- OVERVIEW SECTION (Default View) -->
        <!-- ==================== -->
        <div id="overview-section">
            <!-- Hero Section with Main Action -->
            <section class="hero-section hero-banner">
                <div class="hero-text">
                    <h2>Depo KararÄ±nÄ±zÄ± Veriye DayalÄ± AlÄ±n</h2>
                    <p>MaÄŸaza doluluk oranÄ±, satÄ±ÅŸ trendleri ve depo maliyetlerini analiz ederek en uygun kararÄ± Ã¶neririz.</p>
                </div>
                <button class="btn-primary" id="run-analysis-btn">
                    <span class="btn-icon">ğŸ”</span>
                    Depo SayfasÄ±
                </button>
            </section>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid dashboard-grid-utilization">
                
                <!-- Store Utilization Card -->
                <div class="card card-utilization card-utilization-main" id="store-utilization-card">
                    <div class="card-header">
                        <span class="card-icon">ğŸª</span>
                        <h3>MaÄŸaza Doluluk Durumu</h3>
                        <span class="help-icon help-icon-header" id="db-help-icon" tabindex="0">?
                            <span class="tooltip tooltip-wide">Depo Birimi (DB), Ã¼rÃ¼nlerin kapladÄ±ÄŸÄ± fiziksel alanÄ± temsil eden standart birimdir. MaÄŸaza doluluk oranÄ±, stoklarÄ±n toplam DB deÄŸerinin maÄŸazanÄ±n kullanÄ±labilir DB kapasitesine bÃ¶lÃ¼nmesiyle hesaplanÄ±r.</span>
                        </span>
                    </div>
                    <div class="card-body">
                        <!-- Loading state -->
                        <div class="utilization-loading" id="utilization-loading">
                            <p>Doluluk verileri yÃ¼kleniyor...</p>
                        </div>
                        <!-- Utilization display -->
                        <div class="utilization-display hidden" id="utilization-display">
                            <div class="utilization-circle">
                                <svg viewBox="0 0 100 100">
                                    <circle class="circle-bg" cx="50" cy="50" r="42"></circle>
                                    <circle class="circle-progress" id="utilization-circle-progress" cx="50" cy="50" r="42" 
                                            stroke-dasharray="264" stroke-dashoffset="264"></circle>
                                </svg>
                                <div class="utilization-value">
                                    <span class="value" id="utilization-percent">0</span>
                                    <span class="unit">%</span>
                                </div>
                            </div>
                            <div class="utilization-details">
                                <div class="detail-row">
                                    <span class="label">KullanÄ±lan Alan</span>
                                    <span class="value" id="utilization-used">â€“ DB</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">Toplam Kapasite</span>
                                    <span class="value" id="utilization-capacity">â€“ DB</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">BoÅŸ Alan</span>
                                    <span class="value" id="utilization-free">â€“ DB</span>
                                </div>
                            </div>
                        </div>
                        <!-- Helper text explaining the metric -->
                        <p class="utilization-helper-text hidden" id="utilization-helper-text">
                            Doluluk oranÄ±, toplam stok hacminin maÄŸazanÄ±n kullanÄ±labilir kapasitesine DB (Depo Birimi) cinsinden oranÄ±dÄ±r.
                        </p>
                        <!-- Warning (shown when utilization is high) -->
                        <div class="utilization-warning hidden" id="utilization-warning">
                            <span class="warning-icon">âš ï¸</span>
                            <span id="utilization-warning-text">Doluluk oranÄ± yÃ¼ksek. Depo ihtiyacÄ± deÄŸerlendirilmeli.</span>
                        </div>
                        <!-- No data state -->
                        <div class="utilization-no-data hidden" id="utilization-no-data">
                            <div class="placeholder-icon">ğŸ“Š</div>
                            <p>Doluluk verisi hesaplanamadÄ±. Stok ve kapasite bilgilerini kontrol edin.</p>
                        </div>
                    </div>
                </div>

                <!-- Depo Decision Card -->
                <div class="card card-depo-decision" id="depo-decision-card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ­</span>
                        <h3>Depo Karar Ã–nerisi</h3>
                    </div>
                    <div class="card-body depo-decision-body">
                        <span class="depo-decision-label">KDS Ã–nerisi</span>
                        <div class="depo-decision-status">
                            <span class="depo-decision-badge" id="depo-decision-badge">-</span>
                            <div class="depo-decision-text" id="depo-decision-text">Karar hesaplanÄ±yor...</div>
                        </div>
                        <div class="depo-decision-metrics">
                            <div class="metric-row">
                                <span class="metric-label">Mevcut doluluk oranÄ±</span>
                                <span class="metric-value" id="metric-current-util">- %</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Son 6 ay ortalama doluluk</span>
                                <span class="metric-value" id="metric-average-6m">- %</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">3 ay sonraki tahmini doluluk</span>
                                <span class="metric-value" id="metric-forecast-3m">- %</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Tahmini ek depo maliyeti (aylÄ±k)</span>
                                <span class="metric-value" id="metric-extra-cost">~45.000 TL</span>
                            </div>
                        </div>
                        <p class="depo-decision-summary" id="depo-decision-summary">
                            Doluluk ve satÄ±ÅŸ trendlerine gÃ¶re karar hesaplanÄ±yor...
                        </p>
                    </div>
                </div>

            </div>

            <!-- Karar Paneli (YÃ¶netici Ã–zeti) Section -->
            <section class="decision-panel-section" id="decision-panel-section">
                <div class="section-header-with-filter">
                    <h2>Karar Paneli (YÃ¶netici Ã–zeti)</h2>
                    <div class="filter-bar">
                        <!-- TODO: Populate year options dynamically from available data in the database -->
                        <select id="decision-panel-year" class="filter-select">
                            <option value="2025" selected>2025</option>
                        </select>
                        <select id="decision-panel-month" class="filter-select">
                            <option value="12" selected>AralÄ±k</option>
                            <option value="11">KasÄ±m</option>
                            <option value="10">Ekim</option>
                            <option value="9">EylÃ¼l</option>
                            <option value="8">AÄŸustos</option>
                            <option value="7">Temmuz</option>
                        </select>
                        <button type="button" class="btn-secondary btn-filter-apply" id="decision-panel-apply-btn">
                            Uygula
                        </button>
                    </div>
                </div>

                <!-- KPI Row -->
                <div class="kpi-row">
                    <div class="card card-kpi">
                        <div class="kpi-content">
                            <span class="kpi-label">Toplam AylÄ±k Ciro</span>
                            <span class="kpi-value" id="kpi-monthly-revenue">â€”</span>
                        </div>
                    </div>
                    <div class="card card-kpi">
                        <div class="kpi-content">
                            <span class="kpi-label">SatÄ±ÅŸ Adedi</span>
                            <span class="kpi-value" id="kpi-sales-count">â€”</span>
                        </div>
                    </div>
                    <div class="card card-kpi">
                        <div class="kpi-content">
                            <span class="kpi-label">Kritik Dolulukta Depo</span>
                            <span class="kpi-value" id="kpi-critical-warehouses">â€”</span>
                        </div>
                    </div>
                </div>

                <!-- Main Charts Row -->
                <div class="charts-grid charts-grid-main">
                    <div class="card card-chart" id="revenueTrendCard">
                        <div class="card-header card-header-chart">
                            <div class="card-header-left">
                                <span class="card-icon">ğŸ“ˆ</span>
                                <h3>Son 6 Ay Ciro Trendi</h3>
                                <button type="button" class="chart-toggle-btn" id="revenue-trend-toggle-btn">
                                    Ã–nÃ¼mÃ¼zdeki 6 Ay Tahmini Ciro Trendi
                                </button>
                            </div>
                            <a href="#" class="link-detail" id="link-revenue-trend" onclick="event.preventDefault(); if(window.KDS) window.KDS.showSalesDetailsSection();">Detaya Git â†’</a>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="revenueTrendChartWrap">
                                <canvas id="revenue-trend-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card card-chart" id="bestDepotsCard">
                        <div class="card-header card-header-chart">
                            <div class="card-header-left">
                                <span class="card-icon">ğŸ†</span>
                                <h3>En Uygun Depolar</h3>
                                <span class="help-icon help-icon-inline" id="best-depots-help-icon" tabindex="0" role="button" aria-label="Uygunluk skoru hesaplama bilgisi">?
                                    <span class="tooltip tooltip-wide">Uygunluk skoru; Mesafe, AylÄ±k Kira ve Kapasite kriterlerinin 0â€“100 aralÄ±ÄŸÄ±na normalize edilip aÄŸÄ±rlÄ±klandÄ±rÄ±lmasÄ±yla hesaplanÄ±r.<br><br>AÄŸÄ±rlÄ±klar: Mesafe %50, AylÄ±k Kira %30, Kapasite %20.<br><br>FormÃ¼l: Skor = (MesafeSkoruÃ—0.50) + (KiraSkoruÃ—0.30) + (KapasiteSkoruÃ—0.20).<br><br>Not: YakÄ±n ve ucuz depolar daha yÃ¼ksek puan alÄ±r; kapasite arttÄ±kÃ§a puan artar.</span>
                                </span>
                                <button type="button" class="settings-icon help-icon-inline" id="best-depots-weights-btn" tabindex="0" aria-label="AÄŸÄ±rlÄ±k ayarlarÄ±nÄ± aÃ§" title="AÄŸÄ±rlÄ±k AyarlarÄ±">âš™ï¸</button>
                            </div>
                            <a href="#" class="link-detail" id="link-warehouse-comparison" onclick="event.preventDefault(); if(window.KDS) window.KDS.showAnalysisSection();">Detaya Git â†’</a>
                            <!-- Suitability Weights Settings Panel -->
                            <div class="suitability-weights-panel hidden" id="best-depots-weights-popover">
                                <div class="weights-panel-header">
                                    <h4>AÄŸÄ±rlÄ±k AyarlarÄ±</h4>
                                    <button class="weights-panel-close" id="weights-panel-close" aria-label="Kapat">&times;</button>
                                </div>
                                <div class="weights-panel-body">
                                    <p class="weights-panel-description">Uygunluk skorunu hesaplamak iÃ§in kullanÄ±lan aÄŸÄ±rlÄ±klarÄ± ayarlayÄ±n. Toplam %100 olmalÄ±dÄ±r.</p>
                                    <div class="weights-input-group">
                                        <label for="weight-distance">Mesafe (%):</label>
                                        <input type="number" id="weight-distance" min="0" max="100" step="1" value="50">
                                        <span class="weight-percentage">%</span>
                                    </div>
                                    <div class="weights-input-group">
                                        <label for="weight-rent">AylÄ±k Kira (%):</label>
                                        <input type="number" id="weight-rent" min="0" max="100" step="1" value="30">
                                        <span class="weight-percentage">%</span>
                                    </div>
                                    <div class="weights-input-group">
                                        <label for="weight-capacity">Kapasite (%):</label>
                                        <input type="number" id="weight-capacity" min="0" max="100" step="1" value="20">
                                        <span class="weight-percentage">%</span>
                                    </div>
                                    <div class="weights-total">
                                        <span>Toplam: </span>
                                        <span id="weights-total-value">100</span>%
                                    </div>
                                    <div class="weights-panel-actions">
                                        <button class="btn-secondary" id="weights-reset-btn">VarsayÄ±lana DÃ¶n</button>
                                        <button class="btn-primary" id="weights-apply-btn">Uygula</button>
                                    </div>
                                    <div class="weights-error hidden" id="weights-error"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Content -->
                            <div class="best-depots-content" id="best-depots-content">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            <!-- Empty state -->
                            <div class="best-depots-empty hidden" id="best-depots-empty">
                                <p>HenÃ¼z uygun depo verisi bulunamadÄ±.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Supporting Charts Row -->
                <div class="charts-grid charts-grid-supporting">
                    <div class="card card-chart">
                        <div class="card-header card-header-chart">
                            <div class="card-header-left">
                                <span class="card-icon">ğŸ“¦</span>
                                <h3>Depoyu En Ã‡ok TÃ¼keten ÃœrÃ¼nler (Top 5)</h3>
                            </div>
                            <a href="#" class="link-detail" id="link-top-products" onclick="event.preventDefault(); if(window.KDS) window.KDS.showSalesDetailsSection();">Detaya Git â†’</a>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="top-products-space-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card card-chart">
                        <div class="card-header card-header-chart">
                            <div class="card-header-left">
                                <span class="card-icon">ğŸ”®</span>
                                <h3>Kapasite Tahmini (3 Ay)</h3>
                            </div>
                            <a href="#" class="link-detail" id="link-capacity-forecast" onclick="event.preventDefault(); if(window.KDS) window.KDS.showAnalysisSection();">Detaya Git â†’</a>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="capacity-forecast-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Depot Cost & Capacity Analysis Charts Row -->
                <div class="charts-grid charts-grid-supporting charts-grid-equal-height">
                    <div class="card card-chart">
                        <div class="card-header card-header-chart">
                            <div class="card-header-left">
                                <span class="card-icon">ğŸ’°</span>
                                <h3>Depo BazlÄ± Toplam Maliyet (AylÄ±k)</h3>
                                <span class="help-icon help-icon-inline" id="transport-cost-help-icon" tabindex="0" role="button" aria-label="UlaÅŸtÄ±rma maliyeti hesaplama bilgisi">?
                                    <span class="tooltip tooltip-wide">Tahmini ulaÅŸtÄ±rma maliyeti, sabit tÄ±r Ã¼creti ve mesafeye baÄŸlÄ± yakÄ±t tÃ¼ketimi dikkate alÄ±narak hesaplanÄ±r.<br><br><strong>FormÃ¼l:</strong><br>UlaÅŸtÄ±rma Maliyeti = 15.000 â‚º + (Mesafe (km) Ã— (35 / 100) Ã— 53,08)<br><br><strong>AÃ§Ä±klama:</strong><br>â€¢ 15.000 â‚º: Sabit tÄ±r taÅŸÄ±ma Ã¼creti<br>â€¢ 35 litre / 100 km: Ortalama tÄ±r yakÄ±t tÃ¼ketimi<br>â€¢ 53,08 â‚º / litre: GÃ¼ncel yakÄ±t birim fiyatÄ±<br><br><strong>Not:</strong> Mesafe arttÄ±kÃ§a ulaÅŸtÄ±rma maliyeti doÄŸrusal olarak artar.</span>
                                </span>
                            </div>
                            <button type="button" class="btn-secondary btn-chart-toggle" id="depot-cost-toggle-btn" style="display: none;">
                                TÃ¼m DepolarÄ± GÃ¶ster
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="depot-cost-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card card-chart">
                        <div class="card-header card-header-chart">
                            <div class="card-header-left">
                                <span class="card-icon">ğŸ“Š</span>
                                <h3>Kapasite KullanÄ±m Senaryosu</h3>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="capacity-scenario-chart"></canvas>
                            </div>
                            <p id="capacity-scenario-error-note" style="display: none; margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary); text-align: center;">
                                Senaryo oluÅŸturmak iÃ§in depo verisi bulunamadÄ±.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Inflation & Stock Strategy Section -->
            <section class="inflation-section" id="inflation-section">
                <h2>Enflasyon ve Stok Stratejisi</h2>
                <div class="inflation-grid">
                    <!-- TÃœÄ°K Inflation Summary -->
                    <div class="card card-inflation">
                        <div class="card-header">
                            <span class="card-icon">ğŸ“Š</span>
                            <h3>TÃœÄ°K Resmi Enflasyon OranÄ±</h3>
                        </div>
                        <div class="card-body inflation-summary">
                            <div class="inflation-row">
                                <span class="label">YÄ±llÄ±k Enflasyon:</span>
                                <span class="value"><span id="annualInflationValue">- %</span></span>
                            </div>
                            <div class="inflation-row">
                                <span class="label">AylÄ±k Enflasyon:</span>
                                <span class="value"><span id="monthlyInflationValue">- %</span></span>
                            </div>
                            <p class="inflation-caption">Kaynak: TÃœÄ°K</p>
                            <div class="inflation-trend">
                                <div class="inflation-trend-chart" aria-hidden="true">
                                    <canvas id="inflationSparkline" height="80"></canvas>
                                </div>
                                <p class="inflation-trend-note">
                                    Son 12 ayda enflasyon yukarÄ± yÃ¶nlÃ¼ seyretti ve stok stratejisi hesaplamalarÄ±nda referans gÃ¶sterilmektedir.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Inflation Calculator -->
                    <div class="card card-inflation">
                        <div class="card-header">
                            <span class="card-icon">ğŸ§®</span>
                            <h3>Enflasyon Hesaplama AracÄ±</h3>
                            <span class="help-icon help-icon-inline" id="inflation-calc-help-icon" tabindex="0" role="button" aria-label="Enflasyon hesaplama bilgisi">?
                                <span class="tooltip tooltip-wide">Hesaplanan enflasyon, girilen Ã¼rÃ¼nlerin alÄ±ÅŸ fiyatlarÄ±ndaki ortalama artÄ±ÅŸ oranÄ±dÄ±r.<br><br><strong>Her Ã¼rÃ¼n iÃ§in:</strong><br>ArtÄ±ÅŸ (%) = ((Yeni âˆ’ Ã–nceki) / Ã–nceki) Ã— 100<br><br><strong>SonuÃ§:</strong><br>Girilen Ã¼rÃ¼nlerin ArtÄ±ÅŸ(%) deÄŸerlerinin ortalamasÄ± alÄ±nÄ±r.<br><br><strong>Not:</strong> Ã–nceki fiyat 0 olamaz; boÅŸ alanlar hesaba katÄ±lmaz.</span>
                            </span>
                        </div>
                        <div class="card-body inflation-calculator">
                            <div class="inflation-table">
                                <div class="inflation-table-header">
                                    <span>ÃœrÃ¼n AdÄ±</span>
                                    <span>Ã–nceki AlÄ±ÅŸ FiyatÄ±</span>
                                    <span>Yeni AlÄ±ÅŸ FiyatÄ±</span>
                                </div>
                                <div class="inflation-table-row inflation-calc-row">
                                    <input type="text" class="inflation-input-name" value="E27 BÃ¼yÃ¼k Ampul" aria-label="ÃœrÃ¼n AdÄ±">
                                    <input type="number" class="inflation-input-prev" step="0.01" min="0" placeholder="0.00" aria-label="Ã–nceki AlÄ±ÅŸ FiyatÄ±">
                                    <input type="number" class="inflation-input-new" step="0.01" min="0" placeholder="0.00" aria-label="Yeni AlÄ±ÅŸ FiyatÄ±">
                                </div>
                                <div class="inflation-table-row inflation-calc-row">
                                    <input type="text" class="inflation-input-name" value="Uzatma Kablolu Priz" aria-label="ÃœrÃ¼n AdÄ±">
                                    <input type="number" class="inflation-input-prev" step="0.01" min="0" placeholder="0.00" aria-label="Ã–nceki AlÄ±ÅŸ FiyatÄ±">
                                    <input type="number" class="inflation-input-new" step="0.01" min="0" placeholder="0.00" aria-label="Yeni AlÄ±ÅŸ FiyatÄ±">
                                </div>
                                <div class="inflation-table-row inflation-calc-row">
                                    <input type="text" class="inflation-input-name" value="TV KumandasÄ±" aria-label="ÃœrÃ¼n AdÄ±">
                                    <input type="number" class="inflation-input-prev" step="0.01" min="0" placeholder="0.00" aria-label="Ã–nceki AlÄ±ÅŸ FiyatÄ±">
                                    <input type="number" class="inflation-input-new" step="0.01" min="0" placeholder="0.00" aria-label="Yeni AlÄ±ÅŸ FiyatÄ±">
                                </div>
                                <div class="inflation-table-row inflation-calc-row">
                                    <input type="text" class="inflation-input-name" value="Musluk BataryasÄ±" aria-label="ÃœrÃ¼n AdÄ±">
                                    <input type="number" class="inflation-input-prev" step="0.01" min="0" placeholder="0.00" aria-label="Ã–nceki AlÄ±ÅŸ FiyatÄ±">
                                    <input type="number" class="inflation-input-new" step="0.01" min="0" placeholder="0.00" aria-label="Yeni AlÄ±ÅŸ FiyatÄ±">
                                </div>
                                <div class="inflation-table-row inflation-calc-row">
                                    <input type="text" class="inflation-input-name" value="Dekoratif ArmatÃ¼r" aria-label="ÃœrÃ¼n AdÄ±">
                                    <input type="number" class="inflation-input-prev" step="0.01" min="0" placeholder="0.00" aria-label="Ã–nceki AlÄ±ÅŸ FiyatÄ±">
                                    <input type="number" class="inflation-input-new" step="0.01" min="0" placeholder="0.00" aria-label="Yeni AlÄ±ÅŸ FiyatÄ±">
                                </div>
                            </div>
                            <button type="button" class="btn-primary inflation-calc-btn" id="btn-calc-inflation">Enflasyonu Hesapla</button>
                            <p class="inflation-result">Hesaplanan enflasyon: <span id="calc-inflation-value">-</span> %</p>
                            <p id="stock-decision-message" class="inflation-decision-message"></p>
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <!-- ==================== -->
        <!-- SALES DETAILS SECTION (Hidden by Default) -->
        <!-- ==================== -->
        <div id="sales-details-section" class="hidden">
            <!-- Section Header -->
            <section class="section-header">
                <div class="section-header-left">
                    <h2>ğŸ“Š AylÄ±k SatÄ±ÅŸ Analizi - Detaylar</h2>
                </div>
                <div class="section-header-right">
                    <select id="sales-details-month-select" class="month-select month-select-large">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <button class="btn-secondary" id="back-to-overview-from-sales-details-btn">
                        <span class="btn-icon">â†</span>
                        Ana Ekrana DÃ¶n
                    </button>
                </div>
            </section>

            <!-- Sales Details Content -->
            <div class="sales-details-content">
                <!-- Main Chart Card -->
                <div class="card card-chart card-visible">
                    <div class="card-header card-header-chart">
                        <div class="card-header-left">
                            <span class="card-icon">ğŸ“ˆ</span>
                            <h3>SatÄ±ÅŸ GrafiÄŸi</h3>
                            <div class="chart-mode-toggle">
                                <button type="button" class="chart-mode-btn active" id="chart-mode-revenue" data-mode="revenue">
                                    En Ã§ok ciro yapan 10 Ã¼rÃ¼n
                                </button>
                                <span class="chart-mode-separator">|</span>
                                <button type="button" class="chart-mode-btn" id="chart-mode-quantity" data-mode="quantity">
                                    En Ã§ok satÄ±lan 10 Ã¼rÃ¼n
                                </button>
                            </div>
                        </div>
                        <div class="monthly-total-ciro" id="monthly-total-ciro">
                            <span class="ciro-label">AylÄ±k Toplam Ciro</span>
                            <span class="ciro-value" id="monthly-ciro-value">
                                <span class="ciro-loading">YÃ¼kleniyor...</span>
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large" id="sales-chart-container">
                            <!-- Loading state -->
                            <div class="chart-loading" id="sales-chart-loading">
                                <p>Grafik yÃ¼kleniyor...</p>
                            </div>
                            <!-- No data state -->
                            <p class="chart-no-data hidden" id="sales-chart-no-data">
                                Bu ay iÃ§in grafik verisi bulunmamaktadÄ±r.
                            </p>
                            <!-- Chart canvas -->
                            <canvas id="sales-revenue-chart" class="hidden"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sales Insights Card -->
                <div class="card card-stats card-visible">
                    <div class="card-header">
                        <span class="card-icon">ğŸ“‹</span>
                        <h3>Ã–zet Ä°statistikler</h3>
                        <span class="card-header-subtitle">Son 6 aylÄ±k satÄ±ÅŸ trendi analizi</span>
                    </div>
                    <div class="card-body">
                        <div id="sales-insights-container">
                            <!-- Loading state -->
                            <div class="insights-loading" id="insights-loading">
                                <p>SatÄ±ÅŸ verileri analiz ediliyor...</p>
                            </div>
                            <!-- Insights content -->
                            <div class="insights-content hidden" id="insights-content">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            <!-- No data state -->
                            <p class="insights-no-data hidden" id="insights-no-data">
                                Analiz iÃ§in yeterli veri bulunmamaktadÄ±r.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- AI Decision Support Card -->
                <div class="card card-ai card-visible">
                    <div class="card-header">
                        <span class="card-icon">ğŸ¤–</span>
                        <h3>Yapay Zeka Karar Ã–nerileri</h3>
                    </div>
                    <div class="card-body">
                        <div id="ai-advice-container">
                            <!-- Initial state with explanation -->
                            <div id="ai-advice-initial">
                                <p class="ai-explanation">
                                    SeÃ§ili aya ait satÄ±ÅŸ trendlerine gÃ¶re yapay zekadan aksiyon Ã¶nerileri almak iÃ§in aÅŸaÄŸÄ±daki butona tÄ±klayÄ±n.
                                </p>
                                <button type="button" class="btn-primary btn-ai-advice" id="btn-get-ai-advice">
                                    <span class="btn-icon">âœ¨</span>
                                    Ã–neri Al
                                </button>
                            </div>
                            <!-- Loading state -->
                            <div id="ai-advice-loading" class="hidden">
                                <div class="ai-loading-spinner">
                                    <span class="spinner"></span>
                                    <p>Ã–neriler hazÄ±rlanÄ±yor...</p>
                                </div>
                            </div>
                            <!-- Error state -->
                            <div id="ai-advice-error" class="hidden">
                                <p class="ai-error-message"></p>
                                <button type="button" class="btn-secondary btn-retry" id="btn-retry-ai-advice">
                                    Tekrar Dene
                                </button>
                            </div>
                            <!-- Success state with advice -->
                            <div id="ai-advice-result" class="hidden">
                                <p class="ai-advice-subtitle">Yapay zekanÄ±n Ã¶nerdiÄŸi aksiyonlar:</p>
                                <div class="ai-advice-content" id="ai-advice-content">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                                <button type="button" class="btn-secondary btn-refresh-advice" id="btn-refresh-ai-advice">
                                    <span class="btn-icon">ğŸ”„</span>
                                    Yeniden OluÅŸtur
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- PRODUCTS SECTION (Hidden by Default) -->
        <!-- ==================== -->
        <div id="products-section" class="hidden">
            <!-- Section Header -->
            <section class="section-header">
                <h2>ğŸ“‹ TÃ¼m ÃœrÃ¼nler</h2>
                <div class="section-header-actions">
                    <button class="btn-primary" id="btn-add-product">
                        <span class="btn-icon">â•</span>
                        Yeni ÃœrÃ¼n Ekle
                    </button>
                    <button class="btn-secondary" id="back-to-overview-from-products-btn">
                        <span class="btn-icon">â†</span>
                        Ana Ekrana DÃ¶n
                    </button>
                </div>
            </section>

            <!-- Products Content -->
            <div class="products-content">
                <div class="card card-all-products card-visible">
                    <div class="card-header">
                        <span class="card-icon">ğŸ“‹</span>
                        <div class="card-header-content">
                            <h3>TÃ¼m ÃœrÃ¼nler</h3>
                            <p class="card-subtitle" id="products-count">ÃœrÃ¼nler yÃ¼kleniyor...</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Products Table (shown directly) -->
                        <div id="products-table-container" class="table-container">
                            <table class="data-table" id="products-table">
                                <thead>
                                    <tr>
                                        <th>ÃœrÃ¼n AdÄ±</th>
                                        <th>Kategori</th>
                                        <th>Birim Fiyat</th>
                                        <th>Hacim (DB)</th>
                                        <th class="th-actions">DÃ¼zenleme</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body">
                                    <!-- Products will be loaded dynamically from API -->
                                </tbody>
                            </table>
                        </div>
                        <p class="table-note">* Hacim deÄŸerleri DB (Depo Birimi) cinsinden gÃ¶sterilmektedir.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- ANALYSIS SECTION (Hidden by Default) -->
        <!-- ==================== -->
        <div id="analysis-section" class="hidden">
            <!-- Section Header -->
            <section class="section-header">
                <h2>ğŸ“Š Depolar</h2>
                <button class="btn-secondary" id="back-to-overview-btn">
                    <span class="btn-icon">â†</span>
                    Ana Ekrana DÃ¶n
                </button>
            </section>

            <!-- Analysis Content -->
            <div class="analysis-content">
                <!-- Depolar Section -->
                <section class="depolar-section">
                    <div class="depolar-header">
                        <h2 class="section-title">Depolar</h2>
                        <div class="depolar-header-buttons">
                            <button class="btn-secondary" id="mevcut-depolarim-btn">
                                <span class="btn-icon">ğŸ“¦</span>
                                Mevcut DepolarÄ±m
                            </button>
                            <button class="btn-primary" id="yeni-depo-ekle-btn">
                                <span class="btn-icon">â•</span>
                                Yeni Depo Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Sort Controls -->
                    <div class="depolar-controls">
                        <div class="search-box">
                            <input 
                                type="text" 
                                id="depo-search" 
                                placeholder="Depo adÄ± veya adres ara..." 
                                class="search-input"
                            />
                            <span class="search-icon">ğŸ”</span>
                        </div>
                        <div class="sort-controls">
                            <label for="depo-sort">SÄ±rala:</label>
                            <select id="depo-sort" class="sort-select">
                                <option value="distance">Mesafe (Artan)</option>
                                <option value="distance-desc">Mesafe (Azalan)</option>
                                <option value="rent">AylÄ±k Kira (Artan)</option>
                                <option value="rent-desc">AylÄ±k Kira (Azalan)</option>
                                <option value="capacity">Kapasite (Artan)</option>
                                <option value="capacity-desc">Kapasite (Azalan)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Depolar Table -->
                    <div class="depolar-table-container">
                        <table class="depolar-table" id="depolar-table">
                            <thead>
                                <tr>
                                    <th>FotoÄŸraf</th>
                                    <th>Depo AdÄ±</th>
                                    <th>Mesafe (km)</th>
                                    <th>AylÄ±k Kira (â‚º)</th>
                                    <th>Kapasite (DB)</th>
                                    <th>KullanÄ±labilir Kapasite (DB)</th>
                                    <th>Metrekare</th>
                                    <th>YÃ¼kseklik (m)</th>
                                    <th>Adres</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="depolar-table-body">
                                <tr>
                                    <td colspan="10" class="loading-cell">YÃ¼kleniyor...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <section class="analysis-map-section">
                  <h2 class="section-title">Ä°zmir Depo HaritasÄ±</h2>
                  <p class="section-subtitle">
                    VeritabanÄ±ndaki depolarÄ± Ä°zmir haritasÄ± Ã¼zerinde gÃ¶rsel olarak gÃ¶rÃ¼ntÃ¼ler.
                  </p>
                  <div id="depo-map"></div>
                </section>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>Â© 2025 Lider Elektrik â€“ Karar Destek Sistemi v1.0</p>
        </div>
    </footer>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3>â• Yeni ÃœrÃ¼n Ekle</h3>
                <button class="modal-close-btn" id="modal-close-btn" type="button">&times;</button>
            </div>
            <form id="add-product-form">
                <div class="modal-body">
                <!-- Product Name -->
                <div class="form-group">
                    <label for="product-name">ÃœrÃ¼n AdÄ± <span class="required">*</span></label>
                    <input type="text" id="product-name" name="ad" required placeholder="ÃœrÃ¼n adÄ±nÄ± girin">
                </div>
                
                <!-- Category -->
                <div class="form-group">
                    <label for="product-category">Kategori <span class="required">*</span></label>
                    <select id="product-category" name="kategori_id" required>
                        <option value="">Kategori seÃ§in...</option>
                        <!-- Options will be loaded from API -->
                    </select>
                    <div id="category-error-message" class="form-hint form-error-inline hidden">Kategoriler yÃ¼klenemedi.</div>
                </div>
                
                <!-- Depo Birimi (DB) -->
                <div class="form-group">
                    <label for="product-hacim">
                        Depo Birimi (DB) <span class="required">*</span>
                        <span class="help-icon" id="hacim-help-icon" tabindex="0">?
                            <span class="tooltip">Depo Birimi (DB), Ã¼rÃ¼nÃ¼n depoda kapladÄ±ÄŸÄ± hacmi ifade eden standart bir birimdir. Stok hacmini ve depo kapasitesini karÅŸÄ±laÅŸtÄ±rmak iÃ§in kullanÄ±lÄ±r.</span>
                        </span>
                    </label>
                    <input type="number" id="product-hacim" name="hacim_db" step="0.01" min="0" value="0.10" required placeholder="0.00">
                    <span class="form-hint">Kategoriye gÃ¶re otomatik ayarlanÄ±r, dÃ¼zenlenebilir</span>
                    
                    <!-- Example DB Values Button -->
                    <button type="button" class="btn-info-toggle" id="btn-toggle-db-examples">
                        <span class="toggle-icon">â–¶</span> Ã–rnek Depo Birimleri
                    </button>
                    
                    <!-- Collapsible Example Panel -->
                    <div id="db-examples-panel" class="info-panel hidden">
                        <p class="info-panel-title">Ã–rnek ÃœrÃ¼nler ve DB DeÄŸerleri:</p>
                        <ul class="db-examples-list">
                            <li><span class="example-product">E27 BÃ¼yÃ¼k Ampul</span> <span class="example-value">â†’ 0.20 DB</span></li>
                            <li><span class="example-product">E27 KÃ¼Ã§Ã¼k Ampul</span> <span class="example-value">â†’ 0.12 DB</span></li>
                            <li><span class="example-product">Uzatma Kablolu Priz</span> <span class="example-value">â†’ 0.32 DB</span></li>
                            <li><span class="example-product">TV KumandasÄ±</span> <span class="example-value">â†’ 0.08 DB</span></li>
                            <li><span class="example-product">Uydu KumandasÄ±</span> <span class="example-value">â†’ 0.08 DB</span></li>
                            <li><span class="example-product">Anahtar Priz Tekli</span> <span class="example-value">â†’ 0.12 DB</span></li>
                            <li><span class="example-product">Anahtar Priz Ã‡iftli</span> <span class="example-value">â†’ 0.16 DB</span></li>
                            <li><span class="example-product">Anahtar Priz ÃœÃ§lÃ¼</span> <span class="example-value">â†’ 0.20 DB</span></li>
                            <li><span class="example-product">Anahtar Kopyalama Standart</span> <span class="example-value">â†’ 0.02 DB</span></li>
                            <li><span class="example-product">Anahtar Kopyalama GÃ¼venlikli</span> <span class="example-value">â†’ 0.02 DB</span></li>
                            <li><span class="example-product">Anahtar Kopyalama Ã–zel</span> <span class="example-value">â†’ 0.02 DB</span></li>
                            <li><span class="example-product">Musluk BataryasÄ±</span> <span class="example-value">â†’ 0.20 DB</span></li>
                            <li><span class="example-product">DuÅŸ BaÅŸlÄ±ÄŸÄ±</span> <span class="example-value">â†’ 0.16 DB</span></li>
                            <li><span class="example-product">DuÅŸ Hortumu</span> <span class="example-value">â†’ 0.14 DB</span></li>
                            <li><span class="example-product">Sunta VidasÄ± Kutu</span> <span class="example-value">â†’ 0.02 DB</span></li>
                            <li><span class="example-product">Civata-Somun (Adet)</span> <span class="example-value">â†’ 0.02 DB</span></li>
                            <li><span class="example-product">Boya FÄ±rÃ§asÄ±</span> <span class="example-value">â†’ 0.06 DB</span></li>
                            <li><span class="example-product">Dekoratif AydÄ±nlatma ArmatÃ¼rÃ¼ Ekonomik</span> <span class="example-value">â†’ 0.32 DB</span></li>
                            <li><span class="example-product">Dekoratif AydÄ±nlatma ArmatÃ¼rÃ¼ Orta</span> <span class="example-value">â†’ 0.34 DB</span></li>
                            <li><span class="example-product">Dekoratif AydÄ±nlatma ArmatÃ¼rÃ¼ Premium</span> <span class="example-value">â†’ 0.36 DB</span></li>
                        </ul>
                    </div>
                </div>
                
                <!-- Unit Price -->
                <div class="form-group">
                    <label for="product-price">Birim Fiyat (â‚º) <span class="required">*</span></label>
                    <input type="number" id="product-price" name="birim_fiyat" step="0.01" min="0" required placeholder="0.00">
                </div>
                
                <!-- Stock Quantity -->
                <div class="form-group">
                    <label for="product-adet">Adet/Stok <span class="required">*</span></label>
                    <input type="number" id="product-adet" name="adet" step="1" min="1" value="1" required placeholder="1">
                    <span class="form-hint">ÃœrÃ¼nÃ¼n baÅŸlangÄ±Ã§ stok miktarÄ±</span>
                </div>
                
                <!-- Location Selection -->
                <div class="form-group">
                    <label for="product-lokasyon">Depo SeÃ§ <span class="required">*</span></label>
                    <select id="product-lokasyon" name="lokasyon_id" required>
                        <option value="">Depo seÃ§in...</option>
                        <!-- Options will be loaded from API -->
                    </select>
                    <div id="lokasyon-error-message" class="form-hint form-error-inline hidden">Depolar yÃ¼klenemedi.</div>
                </div>
                
                <!-- Live Preview -->
                <div class="form-group" id="stock-preview-group" style="display: none;">
                    <div class="stock-preview">
                        <p class="stock-preview-text" id="stock-preview-text">
                            <span class="preview-label">KaplayacaÄŸÄ± Alan:</span>
                            <span class="preview-value" id="preview-space-db">â€”</span>
                        </p>
                        <p class="stock-preview-text" id="stock-preview-occupancy">
                            <span class="preview-label">Bu Ã¼rÃ¼n depoyu yaklaÅŸÄ±k</span>
                            <span class="preview-value" id="preview-occupancy-percent">â€”</span>
                            <span class="preview-label">doldurur</span>
                        </p>
                        <p class="stock-preview-text" id="stock-preview-total-occupancy">
                            <span class="preview-label">Bu ekleme sonrasÄ± toplam doluluk:</span>
                            <span class="preview-value" id="preview-total-occupancy-percent">â€”</span>
                        </p>
                    </div>
                </div>
                
                <!-- Error Message -->
                <div id="form-error-message" class="form-error hidden"></div>
                
                <!-- Success Message -->
                <div id="form-success-message" class="form-success hidden"></div>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="modal-cancel-btn">
                    Ä°ptal
                </button>
                <button type="submit" form="add-product-form" class="btn-primary" id="modal-save-btn">
                    <span class="btn-icon">ğŸ’¾</span>
                    Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="modal hidden">
        <div class="modal-backdrop" id="edit-modal-backdrop"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3>âœï¸ ÃœrÃ¼n DÃ¼zenle</h3>
                <button class="modal-close-btn" id="edit-modal-close-btn" type="button">&times;</button>
            </div>
            <form id="edit-product-form">
                <div class="modal-body">
                <!-- Hidden field for product ID -->
                <input type="hidden" id="edit-product-id" name="urun_id">
                
                <!-- Product Name -->
                <div class="form-group">
                    <label for="edit-product-name">ÃœrÃ¼n AdÄ± <span class="required">*</span></label>
                    <input type="text" id="edit-product-name" name="ad" required placeholder="ÃœrÃ¼n adÄ±nÄ± girin">
                </div>
                
                <!-- Category -->
                <div class="form-group">
                    <label for="edit-product-category">Kategori <span class="required">*</span></label>
                    <select id="edit-product-category" name="kategori_id" required>
                        <option value="">Kategori seÃ§in...</option>
                        <!-- Options will be loaded from API -->
                    </select>
                </div>
                
                <!-- Depo Birimi (DB) -->
                <div class="form-group">
                    <label for="edit-product-hacim">
                        Depo Birimi (DB) <span class="required">*</span>
                        <span class="help-icon" tabindex="0">?
                            <span class="tooltip">Depo Birimi (DB), Ã¼rÃ¼nÃ¼n depoda kapladÄ±ÄŸÄ± hacmi ifade eden standart bir birimdir.</span>
                        </span>
                    </label>
                    <input type="number" id="edit-product-hacim" name="hacim_db" step="0.01" min="0" required placeholder="0.00">
                </div>
                
                <!-- Unit Price -->
                <div class="form-group">
                    <label for="edit-product-price">Birim Fiyat (â‚º) <span class="required">*</span></label>
                    <input type="number" id="edit-product-price" name="birim_fiyat" step="0.01" min="0" required placeholder="0.00">
                </div>
                
                <!-- Error Message -->
                <div id="edit-form-error-message" class="form-error hidden"></div>
                
                <!-- Success Message -->
                <div id="edit-form-success-message" class="form-success hidden"></div>
                </div>
            </form>
            <div class="modal-footer modal-footer-split">
                <button type="button" class="btn-danger-outline" id="edit-modal-delete-btn">
                    <span class="btn-icon">ğŸ—‘ï¸</span>
                    ÃœrÃ¼nÃ¼ Sil
                </button>
                <div class="modal-footer-right">
                    <button type="button" class="btn-secondary" id="edit-modal-cancel-btn">
                        Ä°ptal
                    </button>
                    <button type="submit" form="edit-product-form" class="btn-primary" id="edit-modal-save-btn">
                        <span class="btn-icon">ğŸ’¾</span>
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal hidden">
        <div class="modal-backdrop" id="delete-modal-backdrop"></div>
        <div class="modal-container modal-sm">
            <div class="modal-header modal-header-danger">
                <h3>âš ï¸ ÃœrÃ¼nÃ¼ Sil</h3>
                <button class="modal-close-btn" id="delete-modal-close-btn" type="button">&times;</button>
            </div>
            <div class="modal-body">
                <p class="confirm-message">Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinizden emin misiniz?</p>
                <p class="confirm-product-name" id="delete-product-name"></p>
                <p class="confirm-warning">Bu iÅŸlem geri alÄ±namaz.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="delete-modal-cancel-btn">
                    Ä°ptal
                </button>
                <button type="button" class="btn-danger" id="delete-modal-confirm-btn">
                    <span class="btn-icon">ğŸ—‘ï¸</span>
                    Evet, Sil
                </button>
            </div>
        </div>
    </div>

    <!-- Yeni Depo Ekle Modal -->
    <div id="yeni-depo-modal" class="modal hidden">
        <div class="modal-backdrop" id="yeni-depo-modal-backdrop"></div>
        <div class="modal-container modal-lg">
            <div class="modal-header">
                <h3>â• Yeni Depo Ekle</h3>
                <button class="modal-close-btn" id="yeni-depo-modal-close-btn" type="button">&times;</button>
            </div>
            <form id="yeni-depo-form" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-grid">
                        <!-- Depo AdÄ± -->
                        <div class="form-group">
                            <label for="depo-ad">Depo AdÄ± <span class="required">*</span></label>
                            <input type="text" id="depo-ad" name="ad" required placeholder="Ã–rn: KazÄ±mdÄ±rÄ±k Depo">
                        </div>
                        
                        <!-- Adres -->
                        <div class="form-group">
                            <label for="depo-adres">Adres</label>
                            <input type="text" id="depo-adres" name="adres" placeholder="Depo adresi">
                        </div>
                        
                        <!-- Enlem -->
                        <div class="form-group">
                            <label for="depo-enlem">Enlem (Latitude) <span class="required">*</span></label>
                            <input type="number" id="depo-enlem" name="enlem" step="any" required placeholder="38.4237">
                        </div>
                        
                        <!-- Boylam -->
                        <div class="form-group">
                            <label for="depo-boylam">Boylam (Longitude) <span class="required">*</span></label>
                            <input type="number" id="depo-boylam" name="boylam" step="any" required placeholder="27.1428">
                        </div>
                        
                        <!-- Metrekare -->
                        <div class="form-group">
                            <label for="depo-metrekare">Metrekare</label>
                            <input type="number" id="depo-metrekare" name="metrekare" step="0.01" min="0" placeholder="0.00">
                        </div>
                        
                        <!-- YÃ¼kseklik -->
                        <div class="form-group">
                            <label for="depo-yukseklik">YÃ¼kseklik (m)</label>
                            <input type="number" id="depo-yukseklik" name="yukseklik_m" step="0.01" min="0" placeholder="0.00">
                        </div>
                        
                        <!-- Kapasite DB -->
                        <div class="form-group">
                            <label for="depo-kapasite">Kapasite (DB)</label>
                            <input type="number" id="depo-kapasite" name="kapasite_db" step="1" min="0" placeholder="0">
                        </div>
                        
                        <!-- KullanÄ±labilir Oran -->
                        <div class="form-group">
                            <label for="depo-kullanilabilir-oran">KullanÄ±labilir Oran (%)</label>
                            <input type="number" id="depo-kullanilabilir-oran" name="kullanilabilir_oran" step="0.01" min="0" max="100" placeholder="0.00">
                        </div>
                        
                        <!-- KullanÄ±labilir Kapasite DB (Auto-calculated) -->
                        <div class="form-group">
                            <label for="depo-kullanilabilir-kapasite">KullanÄ±labilir Kapasite (DB)</label>
                            <input type="number" id="depo-kullanilabilir-kapasite" name="kullanilabilir_kapasite_db" step="0.01" min="0" placeholder="0.00" readonly>
                            <span class="form-hint">Otomatik hesaplanÄ±r: Kapasite Ã— (KullanÄ±labilir Oran / 100)</span>
                        </div>
                        
                        <!-- AylÄ±k Kira -->
                        <div class="form-group">
                            <label for="depo-aylik-kira">AylÄ±k Kira (â‚º)</label>
                            <input type="number" id="depo-aylik-kira" name="aylik_kira" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                    
                    <!-- Photo Upload -->
                    <div class="form-group">
                        <label for="depo-photos">FotoÄŸraflar</label>
                        <input type="file" id="depo-photos" name="photos" multiple accept="image/*" class="file-input">
                        <span class="form-hint">Birden fazla fotoÄŸraf seÃ§ebilirsiniz (maksimum 5MB her biri)</span>
                    </div>
                    
                    <!-- Photo Preview -->
                    <div id="photo-preview-container" class="photo-preview-container hidden">
                        <label>SeÃ§ilen FotoÄŸraflar:</label>
                        <div id="photo-preview-grid" class="photo-preview-grid"></div>
                    </div>
                    
                    <!-- Error Message -->
                    <div id="yeni-depo-error-message" class="form-error hidden"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="yeni-depo-cancel-btn">Ä°ptal</button>
                    <button type="submit" class="btn-primary" id="yeni-depo-save-btn">
                        <span class="btn-icon">ğŸ’¾</span>
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-depot-modal" class="modal hidden">
        <div class="modal-backdrop" id="delete-depot-modal-backdrop"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3>Depo Silinsin mi?</h3>
                <button class="modal-close-btn" id="delete-depot-modal-close-btn" type="button">&times;</button>
            </div>
            <div class="modal-body">
                <p id="delete-depot-message">Bu depo listeden kaldÄ±rÄ±lacak. Geri alÄ±nabilir.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="delete-depot-cancel-btn">Ä°ptal</button>
                <button type="button" class="btn btn-danger" id="delete-depot-confirm-btn">Sil</button>
            </div>
        </div>
    </div>

    <!-- Mevcut DepolarÄ±m Modal -->
    <div id="mevcut-depolarim-modal" class="modal hidden">
        <div class="modal-backdrop" id="mevcut-depolarim-modal-backdrop"></div>
        <div class="modal-container modal-lg modal-owned-depots">
            <div class="modal-header">
                <h3>ğŸ“¦ Mevcut DepolarÄ±m</h3>
                <button class="modal-close-btn" id="mevcut-depolarim-modal-close-btn" type="button">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mevcut-depolarim-loading" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Depolar yÃ¼kleniyor...</p>
                </div>
                <div id="mevcut-depolarim-content" class="hidden">
                    <div id="mevcut-depolarim-table-container" class="depolar-table-container">
                        <table class="depolar-table" id="mevcut-depolarim-table">
                            <thead>
                                <tr>
                                    <th>FotoÄŸraf</th>
                                    <th>Depo AdÄ±</th>
                                    <th>Mesafe (km)</th>
                                    <th>AylÄ±k Kira (â‚º)</th>
                                    <th>Kapasite (DB)</th>
                                    <th>KullanÄ±lan (DB)</th>
                                    <th>Doluluk OranÄ±</th>
                                    <th>Durum</th>
                                    <th title="Metrekare (mÂ²)">Metrekare</th>
                                    <th title="YÃ¼kseklik (m)">YÃ¼kseklik (m)</th>
                                    <th>Adres</th>
                                </tr>
                            </thead>
                            <tbody id="mevcut-depolarim-table-body">
                            </tbody>
                        </table>
                    </div>
                    <div id="mevcut-depolarim-empty" class="no-data-cell hidden" style="text-align: center; padding: 2rem;">
                        <p>HenÃ¼z satÄ±n alÄ±nmÄ±ÅŸ depo bulunmamaktadÄ±r.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="mevcut-depolarim-close-btn">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Photo Modal/Lightbox -->
    <div id="photo-modal" class="modal hidden">
        <div class="modal-backdrop" id="photo-modal-backdrop"></div>
        <div class="modal-container modal-photo">
            <div class="modal-header">
                <h3 id="photo-modal-title">Depo FotoÄŸraflarÄ±</h3>
                <button class="modal-close-btn" id="photo-modal-close-btn" type="button">&times;</button>
            </div>
            <div class="modal-body photo-modal-body">
                <div class="photo-viewer">
                    <button class="photo-nav-btn photo-nav-prev" id="photo-prev-btn" aria-label="Ã–nceki fotoÄŸraf">â€¹</button>
                    <div class="photo-container">
                        <img id="photo-modal-image" src="" alt="Depo fotoÄŸrafÄ±" />
                        <div class="photo-counter">
                            <span id="photo-current">1</span> / <span id="photo-total">1</span>
                        </div>
                    </div>
                    <button class="photo-nav-btn photo-nav-next" id="photo-next-btn" aria-label="Sonraki fotoÄŸraf">â€º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/main.js"></script>
    <script src="/js/inflation.js"></script>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      let depoMap = null;
      let depoMapInitialized = false;
      // Store markers by lokasyon_id for table interaction
      const depoMarkers = new Map();

      function initDepoMap() {
        const mapContainer = document.getElementById('depo-map');
        if (!mapContainer) return;

        // If map already created, just fix the size and re-center
        if (depoMapInitialized && depoMap) {
          depoMap.invalidateSize();
          depoMap.setView([38.4237, 27.1428], 11);
          return;
        }

        // Default center (Izmir) - will be adjusted after loading business location
        const izmirCenter = [38.4237, 27.1428];

        depoMap = L.map('depo-map').setView(izmirCenter, 11);

        L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; OpenMapTiles &copy; OpenStreetMap contributors'
        }).addTo(depoMap);

        // Create custom store icon for our business
        const storeIcon = L.divIcon({
          className: 'custom-store-icon',
          html: `
            <div style="
              width: 40px;
              height: 40px;
              background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
              border: 3px solid #ffffff;
              border-radius: 8px 8px 8px 2px;
              box-shadow: 0 3px 10px rgba(0,0,0,0.4);
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
              transform: rotate(-2deg);
            ">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 21H21V8L12 3L3 8V21Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 10H21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M9 10V21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M15 10V21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="15" r="1.5" fill="white"/>
              </svg>
            </div>
          `,
          iconSize: [40, 40],
          iconAnchor: [20, 40],
          popupAnchor: [0, -40]
        });

        // Store all markers for bounds calculation
        const allMarkers = [];
        let businessMarker = null;

        // Fetch business location from API
        fetch('/api/business')
          .then(response => {
            if (!response.ok) {
              return response.json().then(err => {
                throw new Error(err.error || 'Ana maÄŸaza konumu alÄ±namadÄ±');
              });
            }
            return response.json();
          })
          .then(business => {
            // Validate coordinates
            if (!business.enlem || !business.boylam || 
                isNaN(parseFloat(business.enlem)) || isNaN(parseFloat(business.boylam))) {
              console.error('âŒ GeÃ§ersiz koordinatlar:', business);
              return;
            }

            // Add business marker with custom icon
            businessMarker = L.marker(
              [business.enlem, business.boylam],
              { icon: storeIcon }
            ).addTo(depoMap);

            // Attach popup to business marker
            const businessName = business.ad || 'Lider Elektrik (Ana MaÄŸaza)';
            businessMarker.bindPopup(`
              <div style="text-align: center; padding: 4px;">
                <strong style="font-size: 14px;">ğŸ¬ ${businessName}</strong><br>
                <span style="font-size: 12px; color: #666;">Ana iÅŸletme konumu</span>
              </div>
            `);

            allMarkers.push(businessMarker);

            // Load depots and adjust map view
            return fetch('/api/depots');
          })
          .then(response => {
            if (!response) return null;
            return response.json();
          })
          .then(depolar => {
            if (!depolar || !Array.isArray(depolar)) return;

            depolar.forEach(depo => {
              const lat = depo.latitude ?? depo.enlem;
              const lng = depo.longitude ?? depo.boylam;
              if (!lat || !lng) return;

              const marker = L.marker([lat, lng]).addTo(depoMap);
              const name = depo.name || depo.depo_adi || 'Depo';
              marker.bindPopup(`<strong>${name}</strong>`);
              allMarkers.push(marker);
              
              // Store marker by lokasyon_id for table interaction
              const depoId = depo.id || depo.lokasyon_id;
              if (depoId) {
                depoMarkers.set(depoId, marker);
              }
            });

            // Adjust map view to show all markers
            if (allMarkers.length > 0) {
              if (allMarkers.length > 1) {
                // Fit bounds to include all markers (business + warehouses)
                const group = new L.featureGroup(allMarkers);
                depoMap.fitBounds(group.getBounds().pad(0.1));
              } else if (businessMarker) {
                // If only business marker, center on it
                depoMap.setView([businessMarker.getLatLng().lat, businessMarker.getLatLng().lng], 12);
              }
            }
          })
          .catch(err => {
            console.error('âŒ Ana maÄŸaza veya depo verileri alÄ±nÄ±rken hata oluÅŸtu:', err);
            // If error, try to load depots anyway
            fetch('/api/depots')
              .then(response => response.json())
              .then(depolar => {
                if (!Array.isArray(depolar)) return;
                depolar.forEach(depo => {
                  const lat = depo.latitude ?? depo.enlem;
                  const lng = depo.longitude ?? depo.boylam;
                  if (!lat || !lng) return;
                  const marker = L.marker([lat, lng]).addTo(depoMap);
                  const name = depo.name || depo.depo_adi || 'Depo';
                  marker.bindPopup(`<strong>${name}</strong>`);
                });
              })
              .catch(depoErr => {
                console.error('âŒ Depo verileri alÄ±nÄ±rken hata oluÅŸtu:', depoErr);
              });
          });

        depoMapInitialized = true;
      }

      // Depolar table functionality
      let allDepotsData = [];
      let filteredDepotsData = [];
      
      // Photo modal state (global scope for accessibility)
      let currentPhotos = [];
      let currentPhotoIndex = 0;

      function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return parseFloat(num).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function formatCurrency(num) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return parseFloat(num).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' â‚º';
      }

      function renderDepotsTable(depots) {
        const tbody = document.getElementById('depolar-table-body');
        if (!tbody) return;

        if (depots.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" class="no-data-cell">Depo bulunamadÄ±.</td></tr>';
          return;
        }

        tbody.innerHTML = depots.map(depo => {
          const distance = depo.distance_km !== null ? formatNumber(depo.distance_km) + ' km' : '-';
          const rent = formatCurrency(depo.aylik_kira);
          const capacity = formatNumber(depo.kapasite_db);
          const availableCapacity = formatNumber(depo.kullanilabilir_kapasite_db);
          const area = depo.metrekare ? formatNumber(depo.metrekare) + ' mÂ²' : '-';
          const height = depo.yukseklik_m ? formatNumber(depo.yukseklik_m) + ' m' : '-';
          const address = depo.adres || '-';
          
          // Photo thumbnail
          const photos = depo.photos || [];
          const firstPhoto = photos.length > 0 ? photos[0].foto_url : null;
          const photoThumbnail = firstPhoto 
            ? `<button type="button" class="depo-thumbnail-btn" data-lokasyon-id="${depo.lokasyon_id}" data-photos='${JSON.stringify(photos)}' aria-label="FotoÄŸraflarÄ± gÃ¶rÃ¼ntÃ¼le"><img src="${firstPhoto}" alt="${depo.ad || 'Depo'}" class="depo-thumbnail" /></button>`
            : '<div class="depo-thumbnail-placeholder">ğŸ“·</div>';

          const isOwned = depo.sahip_miyiz === 1;
          const ownedBadge = isOwned ? '<span class="owned-badge">âœ… SatÄ±n AlÄ±ndÄ±</span>' : '';
          
          return `
            <tr data-lokasyon-id="${depo.lokasyon_id}" class="depo-row" data-owned="${isOwned ? '1' : '0'}">
              <td data-label="FotoÄŸraf" class="photo-cell">${photoThumbnail}</td>
              <td data-label="Depo AdÄ±"><strong>${depo.ad || 'Depo'}</strong> ${ownedBadge}</td>
              <td data-label="Mesafe">${distance}</td>
              <td data-label="AylÄ±k Kira">${rent}</td>
              <td data-label="Kapasite (DB)">${capacity}</td>
              <td data-label="KullanÄ±labilir Kapasite (DB)">${availableCapacity}</td>
              <td data-label="Metrekare">${area}</td>
              <td data-label="YÃ¼kseklik">${height}</td>
              <td data-label="Adres" class="address-cell">${address}</td>
              <td data-label="Ä°ÅŸlemler" class="actions-cell">
                <div class="action-buttons">
                  <button type="button" class="btn-action btn-satin-al ${isOwned ? 'disabled' : ''}" 
                          data-lokasyon-id="${depo.lokasyon_id}" 
                          ${isOwned ? 'disabled' : ''}
                          title="${isOwned ? 'Zaten satÄ±n alÄ±ndÄ±' : 'SatÄ±n alÄ±ndÄ± olarak iÅŸaretle'}">
                    SatÄ±n AldÄ±m
                  </button>
                  <button type="button" class="btn-action btn-delete" 
                          data-lokasyon-id="${depo.lokasyon_id}" 
                          data-depo-ad="${depo.ad || 'Depo'}"
                          title="Depoyu sil">
                    Sil
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        // Add click handlers to rows (but not photo cells or action buttons)
        tbody.querySelectorAll('.depo-row').forEach(row => {
          row.style.cursor = 'pointer';
          row.addEventListener('click', function(e) {
            // Don't trigger row click if clicking on photo thumbnail or action buttons
            if (e.target.closest('.photo-cell') || e.target.closest('.actions-cell')) return;
            const lokasyonId = parseInt(this.dataset.lokasyonId);
            highlightMarker(lokasyonId);
          });
          row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'var(--bg-hover, rgba(255, 255, 255, 0.05))';
          });
          row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
          });
        });
        
        // Add click handlers to action buttons
        tbody.querySelectorAll('.btn-satin-al').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent row click
            if (this.disabled) return;
            const lokasyonId = parseInt(this.dataset.lokasyonId);
            markDepotAsOwned(lokasyonId, this);
          });
        });
        
        tbody.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent row click
            const lokasyonId = parseInt(this.dataset.lokasyonId);
            const depoAd = this.dataset.depoAd || 'Depo';
            showDeleteConfirmation(lokasyonId, depoAd);
          });
        });

        // Add click handlers to photo thumbnails
        tbody.querySelectorAll('.depo-thumbnail-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent row click
            e.preventDefault(); // Prevent any default behavior
            const photos = JSON.parse(this.dataset.photos || '[]');
            const lokasyonId = this.dataset.lokasyonId;
            const depoName = this.closest('.depo-row').querySelector('td[data-label="Depo AdÄ±"] strong').textContent;
            if (typeof openPhotoModal === 'function') {
              openPhotoModal(photos, lokasyonId, depoName);
            } else {
              console.error('openPhotoModal function not found');
            }
          });
        });
      }
      
      // Photo modal functions (global scope)
      function openPhotoModal(photos, lokasyonId, depoName) {
        if (!photos || photos.length === 0) {
          console.warn('No photos to display');
          return;
        }
        
        const photoModal = document.getElementById('photo-modal');
        if (!photoModal) {
          console.error('Photo modal element not found');
          return;
        }
        
        currentPhotos = photos;
        currentPhotoIndex = 0;
        
        const photoModalTitle = document.getElementById('photo-modal-title');
        const photoModalImage = document.getElementById('photo-modal-image');
        const photoCurrent = document.getElementById('photo-current');
        const photoTotal = document.getElementById('photo-total');
        
        if (photoModalTitle) photoModalTitle.textContent = `${depoName} - FotoÄŸraflar`;
        if (photoTotal) photoTotal.textContent = photos.length;
        updatePhotoDisplay();
        
        photoModal.classList.remove('hidden');
        if (typeof lockBodyScroll === 'function') {
          lockBodyScroll(true);
        } else {
          document.body.style.overflow = 'hidden';
        }
      }

      function closePhotoModal() {
        const photoModal = document.getElementById('photo-modal');
        if (photoModal) {
          photoModal.classList.add('hidden');
        }
        if (typeof lockBodyScroll === 'function') {
          lockBodyScroll(false);
        } else {
          document.body.style.overflow = '';
        }
        currentPhotos = [];
        currentPhotoIndex = 0;
      }

      function updatePhotoDisplay() {
        if (currentPhotos.length === 0) return;
        
        const photoModalImage = document.getElementById('photo-modal-image');
        const photoCurrent = document.getElementById('photo-current');
        const photoPrevBtn = document.getElementById('photo-prev-btn');
        const photoNextBtn = document.getElementById('photo-next-btn');
        
        if (!photoModalImage || !photoCurrent) return;
        
        const currentPhoto = currentPhotos[currentPhotoIndex];
        photoModalImage.src = currentPhoto.foto_url;
        photoCurrent.textContent = currentPhotoIndex + 1;
        
        // Show/hide navigation buttons
        if (photoPrevBtn) {
          photoPrevBtn.style.display = currentPhotoIndex === 0 ? 'none' : 'flex';
        }
        if (photoNextBtn) {
          photoNextBtn.style.display = currentPhotoIndex === currentPhotos.length - 1 ? 'none' : 'flex';
        }
      }

      function showNextPhoto() {
        if (currentPhotoIndex < currentPhotos.length - 1) {
          currentPhotoIndex++;
          updatePhotoDisplay();
        }
      }

      function showPrevPhoto() {
        if (currentPhotoIndex > 0) {
          currentPhotoIndex--;
          updatePhotoDisplay();
        }
      }

      function highlightMarker(lokasyonId) {
        const marker = depoMarkers.get(lokasyonId);
        if (!marker || !depoMap) return;

        // Open popup and pan to marker
        marker.openPopup();
        depoMap.setView(marker.getLatLng(), Math.max(depoMap.getZoom(), 14));
        
        // Add highlight effect with a pulsing circle
        const highlightCircle = L.circle(marker.getLatLng(), {
          radius: 200,
          color: '#FF6B35',
          fillColor: '#FF6B35',
          fillOpacity: 0.2,
          weight: 3
        }).addTo(depoMap);

        // Remove highlight after 2 seconds
        setTimeout(() => {
          depoMap.removeLayer(highlightCircle);
        }, 2000);
      }
      
      // Remove marker from map
      function removeMarker(lokasyonId) {
        const marker = depoMarkers.get(lokasyonId);
        if (marker && depoMap) {
          depoMap.removeLayer(marker);
          depoMarkers.delete(lokasyonId);
        }
      }
      
      // Update marker popup text
      function updateMarkerPopup(lokasyonId, data) {
        const marker = depoMarkers.get(lokasyonId);
        if (!marker) return;
        
        const depo = allDepotsData.find(d => d.lokasyon_id === lokasyonId);
        if (!depo) return;
        
        let popupContent = `<strong>${depo.ad || 'Depo'}</strong>`;
        if (data && data.sahip_miyiz === 1) {
          popupContent += '<br><span style="color: #10b981;">âœ… SatÄ±n AlÄ±ndÄ±</span>';
        }
        marker.setPopupContent(popupContent);
      }
      
      // Reload depots for map
      function loadDepotsForMap() {
        if (!depoMapInitialized || !depoMap) return;
        
        // Clear existing markers (except business)
        depoMarkers.forEach((marker) => {
          depoMap.removeLayer(marker);
        });
        depoMarkers.clear();
        
        // Reload depots and add markers
        fetch('/api/depots')
          .then(response => response.json())
          .then(depolar => {
            if (Array.isArray(depolar)) {
              depolar.forEach(depo => {
                // Validate coordinates: use latitude/longitude or enlem/boylam, ensure they are finite numbers
                const lat = Number(depo.latitude ?? depo.enlem);
                const lng = Number(depo.longitude ?? depo.boylam);
                
                // Skip marker if lat/lng are not finite numbers
                if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                  console.warn('âš ï¸ Skipping depot marker - invalid coordinates:', {
                    id: depo.id || depo.lokasyon_id,
                    name: depo.name || depo.depo_adi || 'Depo',
                    lat: depo.latitude ?? depo.enlem,
                    lng: depo.longitude ?? depo.boylam
                  });
                  return;
                }
                
                const marker = L.marker([lat, lng]).addTo(depoMap);
                const name = depo.name || depo.depo_adi || 'Depo';
                let popupContent = `<strong>${name}</strong>`;
                if (depo.sahip_miyiz === 1) {
                  popupContent += '<br><span style="color: #10b981;">âœ… SatÄ±n AlÄ±ndÄ±</span>';
                }
                marker.bindPopup(popupContent);
                
                const depoId = depo.id || depo.lokasyon_id;
                if (depoId) {
                  depoMarkers.set(depoId, marker);
                }
              });
            }
          })
          .catch(err => {
            console.error('âŒ Depo verileri alÄ±nÄ±rken hata oluÅŸtu:', err);
          });
      }

      function filterDepots(searchTerm) {
        if (!searchTerm || searchTerm.trim() === '') {
          filteredDepotsData = [...allDepotsData];
        } else {
          const term = searchTerm.toLowerCase().trim();
          filteredDepotsData = allDepotsData.filter(depo => {
            const name = (depo.ad || '').toLowerCase();
            const address = (depo.adres || '').toLowerCase();
            return name.includes(term) || address.includes(term);
          });
        }
        sortDepots();
      }

      function sortDepots() {
        const sortSelect = document.getElementById('depo-sort');
        if (!sortSelect) return;

        const sortValue = sortSelect.value;
        let sorted = [...filteredDepotsData];

        switch(sortValue) {
          case 'distance':
            sorted.sort((a, b) => {
              if (a.distance_km === null && b.distance_km === null) return 0;
              if (a.distance_km === null) return 1;
              if (b.distance_km === null) return -1;
              return a.distance_km - b.distance_km;
            });
            break;
          case 'distance-desc':
            sorted.sort((a, b) => {
              if (a.distance_km === null && b.distance_km === null) return 0;
              if (a.distance_km === null) return 1;
              if (b.distance_km === null) return -1;
              return b.distance_km - a.distance_km;
            });
            break;
          case 'rent':
            sorted.sort((a, b) => {
              const rentA = a.aylik_kira || 0;
              const rentB = b.aylik_kira || 0;
              return rentA - rentB;
            });
            break;
          case 'rent-desc':
            sorted.sort((a, b) => {
              const rentA = a.aylik_kira || 0;
              const rentB = b.aylik_kira || 0;
              return rentB - rentA;
            });
            break;
          case 'capacity':
            sorted.sort((a, b) => {
              const capA = a.kapasite_db || 0;
              const capB = b.kapasite_db || 0;
              return capA - capB;
            });
            break;
          case 'capacity-desc':
            sorted.sort((a, b) => {
              const capA = a.kapasite_db || 0;
              const capB = b.kapasite_db || 0;
              return capB - capA;
            });
            break;
        }

        renderDepotsTable(sorted);
      }

      function loadDepotsTable() {
        const tbody = document.getElementById('depolar-table-body');
        if (!tbody) return;

        fetch('/api/depolar-detay')
          .then(response => {
            if (!response.ok) {
              throw new Error('Depo verileri alÄ±namadÄ±');
            }
            return response.json();
          })
          .then(data => {
            if (data.success && data.depolar) {
              allDepotsData = data.depolar;
              filteredDepotsData = [...allDepotsData];
              sortDepots();
            } else {
              tbody.innerHTML = '<tr><td colspan="10" class="error-cell">Depo verileri yÃ¼klenemedi.</td></tr>';
            }
          })
          .catch(err => {
            console.error('âŒ Depo tablosu yÃ¼klenirken hata:', err);
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="10" class="error-cell">Depo verileri yÃ¼klenirken bir hata oluÅŸtu.</td></tr>';
            }
          });
      }

      // Optional: do nothing on DOMContentLoaded except maybe prepare things
      document.addEventListener('DOMContentLoaded', function () {
        const analysisButton = document.getElementById('run-analysis-btn');
        if (analysisButton) {
          analysisButton.addEventListener('click', function () {
            // Ensure map is initialized after the analysis section becomes visible
            setTimeout(initDepoMap, 0);
            // Load depots table
            setTimeout(loadDepotsTable, 100);
          });
        }

        // Search functionality
        const searchInput = document.getElementById('depo-search');
        if (searchInput) {
          searchInput.addEventListener('input', function(e) {
            filterDepots(e.target.value);
          });
        }

        // Sort functionality
        const sortSelect = document.getElementById('depo-sort');
        if (sortSelect) {
          sortSelect.addEventListener('change', function() {
            sortDepots();
          });
        }

        // Photo modal event listeners (functions are defined globally above)
        const photoModal = document.getElementById('photo-modal');
        const photoModalBackdrop = document.getElementById('photo-modal-backdrop');
        const photoModalClose = document.getElementById('photo-modal-close-btn');
        const photoPrevBtn = document.getElementById('photo-prev-btn');
        const photoNextBtn = document.getElementById('photo-next-btn');

        // Event listeners for photo modal
        if (photoModalBackdrop) {
          photoModalBackdrop.addEventListener('click', closePhotoModal);
        }
        if (photoModalClose) {
          photoModalClose.addEventListener('click', closePhotoModal);
        }
        if (photoPrevBtn) {
          photoPrevBtn.addEventListener('click', showPrevPhoto);
        }
        if (photoNextBtn) {
          photoNextBtn.addEventListener('click', showNextPhoto);
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
          if (photoModal && !photoModal.classList.contains('hidden')) {
            if (e.key === 'Escape') {
              closePhotoModal();
            } else if (e.key === 'ArrowLeft') {
              showPrevPhoto();
            } else if (e.key === 'ArrowRight') {
              showNextPhoto();
            }
          }
        });

        // Yeni Depo Ekle Modal functionality
        const yeniDepoModal = document.getElementById('yeni-depo-modal');
        const yeniDepoModalBackdrop = document.getElementById('yeni-depo-modal-backdrop');
        const yeniDepoModalClose = document.getElementById('yeni-depo-modal-close-btn');
        const yeniDepoCancelBtn = document.getElementById('yeni-depo-cancel-btn');
        const yeniDepoForm = document.getElementById('yeni-depo-form');
        const yeniDepoBtn = document.getElementById('yeni-depo-ekle-btn');
        const depoPhotosInput = document.getElementById('depo-photos');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const photoPreviewGrid = document.getElementById('photo-preview-grid');
        const yeniDepoErrorMessage = document.getElementById('yeni-depo-error-message');

        // Utility function to lock/unlock body scroll
        function lockBodyScroll(lock) {
          if (lock) {
            const scrollY = window.scrollY;
            document.body.classList.add('modal-open');
            document.body.style.top = `-${scrollY}px`;
          } else {
            const scrollY = document.body.style.top;
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            if (scrollY) {
              window.scrollTo(0, parseInt(scrollY.replace('-', '')) || 0);
            }
          }
        }
        
        function openYeniDepoModal() {
          if (yeniDepoModal) {
            yeniDepoModal.classList.remove('hidden');
            lockBodyScroll(true);
          }
        }
        
        function closeYeniDepoModal() {
          if (yeniDepoModal) {
            yeniDepoModal.classList.add('hidden');
            lockBodyScroll(false);
            // Reset form
            if (yeniDepoForm) {
              yeniDepoForm.reset();
            }
            // Clear photo preview
            if (photoPreviewContainer) {
              photoPreviewContainer.classList.add('hidden');
            }
            if (photoPreviewGrid) {
              photoPreviewGrid.innerHTML = '';
            }
            // Clear error message
            if (yeniDepoErrorMessage) {
              yeniDepoErrorMessage.classList.add('hidden');
              yeniDepoErrorMessage.textContent = '';
            }
            // Reset calculated field
            calculateKullanilabilirKapasite();
          }
        }

        // Calculate kullanilabilir_kapasite_db
        function calculateKullanilabilirKapasite() {
          const kapasiteInput = document.getElementById('depo-kapasite');
          const oranInput = document.getElementById('depo-kullanilabilir-oran');
          const kullanilabilirKapasiteInput = document.getElementById('depo-kullanilabilir-kapasite');
          
          if (!kapasiteInput || !oranInput || !kullanilabilirKapasiteInput) return;
          
          const kapasite = parseFloat(kapasiteInput.value) || 0;
          const oran = parseFloat(oranInput.value) || 0;
          
          let calculatedValue = null;
          if (kapasite > 0 && oran > 0) {
            calculatedValue = kapasite * (oran / 100);
            // Round to 2 decimal places
            calculatedValue = Math.round(calculatedValue * 100) / 100;
          } else if (kapasite > 0 && oran === 0) {
            calculatedValue = 0;
          }
          
          if (calculatedValue !== null) {
            kullanilabilirKapasiteInput.value = calculatedValue.toFixed(2);
          } else {
            kullanilabilirKapasiteInput.value = '';
          }
        }

        // Photo preview functionality
        function updatePhotoPreview() {
          if (!depoPhotosInput || !photoPreviewContainer || !photoPreviewGrid) return;
          
          const files = depoPhotosInput.files;
          
          if (files.length === 0) {
            photoPreviewContainer.classList.add('hidden');
            photoPreviewGrid.innerHTML = '';
            return;
          }
          
          photoPreviewContainer.classList.remove('hidden');
          photoPreviewGrid.innerHTML = '';
          
          Array.from(files).forEach((file, index) => {
            if (!file.type.startsWith('image/')) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
              const previewItem = document.createElement('div');
              previewItem.className = 'photo-preview-item';
              previewItem.innerHTML = `
                <img src="${e.target.result}" alt="Preview ${index + 1}" />
                <button type="button" class="photo-preview-remove" data-index="${index}">Ã—</button>
              `;
              photoPreviewGrid.appendChild(previewItem);
              
              // Remove button handler
              const removeBtn = previewItem.querySelector('.photo-preview-remove');
              if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                  const dt = new DataTransfer();
                  Array.from(depoPhotosInput.files).forEach((f, i) => {
                    if (i !== index) dt.items.add(f);
                  });
                  depoPhotosInput.files = dt.files;
                  updatePhotoPreview();
                });
              }
            };
            reader.readAsDataURL(file);
          });
        }

        // Event listeners for Mevcut DepolarÄ±m Modal
        const mevcutDepolarimBtn = document.getElementById('mevcut-depolarim-btn');
        const mevcutDepolarimModal = document.getElementById('mevcut-depolarim-modal');
        const mevcutDepolarimModalBackdrop = document.getElementById('mevcut-depolarim-modal-backdrop');
        const mevcutDepolarimModalClose = document.getElementById('mevcut-depolarim-modal-close-btn');
        const mevcutDepolarimCloseBtn = document.getElementById('mevcut-depolarim-close-btn');
        
        if (mevcutDepolarimBtn) {
          mevcutDepolarimBtn.addEventListener('click', openOwnedDepotsModal);
        }
        if (mevcutDepolarimModalBackdrop) {
          mevcutDepolarimModalBackdrop.addEventListener('click', closeOwnedDepotsModal);
        }
        if (mevcutDepolarimModalClose) {
          mevcutDepolarimModalClose.addEventListener('click', closeOwnedDepotsModal);
        }
        if (mevcutDepolarimCloseBtn) {
          mevcutDepolarimCloseBtn.addEventListener('click', closeOwnedDepotsModal);
        }
        
        // Keyboard navigation for Mevcut DepolarÄ±m Modal
        document.addEventListener('keydown', function(e) {
          if (mevcutDepolarimModal && !mevcutDepolarimModal.classList.contains('hidden')) {
            if (e.key === 'Escape') {
              closeOwnedDepotsModal();
            }
          }
        });

        // Event listeners for Yeni Depo Modal
        if (yeniDepoBtn) {
          yeniDepoBtn.addEventListener('click', openYeniDepoModal);
        }
        if (yeniDepoModalBackdrop) {
          yeniDepoModalBackdrop.addEventListener('click', closeYeniDepoModal);
        }
        if (yeniDepoModalClose) {
          yeniDepoModalClose.addEventListener('click', closeYeniDepoModal);
        }
        if (yeniDepoCancelBtn) {
          yeniDepoCancelBtn.addEventListener('click', closeYeniDepoModal);
        }
        if (depoPhotosInput) {
          depoPhotosInput.addEventListener('change', updatePhotoPreview);
        }

        // Auto-calculate kullanilabilir_kapasite_db when kapasite_db or kullanilabilir_oran changes
        const depoKapasiteInput = document.getElementById('depo-kapasite');
        const depoOranInput = document.getElementById('depo-kullanilabilir-oran');
        
        if (depoKapasiteInput) {
          depoKapasiteInput.addEventListener('input', calculateKullanilabilirKapasite);
          depoKapasiteInput.addEventListener('change', calculateKullanilabilirKapasite);
        }
        
        if (depoOranInput) {
          depoOranInput.addEventListener('input', calculateKullanilabilirKapasite);
          depoOranInput.addEventListener('change', calculateKullanilabilirKapasite);
        }

        // Form submission
        if (yeniDepoForm) {
          yeniDepoForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('yeni-depo-save-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="btn-icon">â³</span> Kaydediliyor...';
            
            if (yeniDepoErrorMessage) {
              yeniDepoErrorMessage.classList.add('hidden');
              yeniDepoErrorMessage.textContent = '';
            }
            
            try {
              const formData = new FormData(yeniDepoForm);
              
              const response = await fetch('/api/depolar', {
                method: 'POST',
                body: formData
              });
              
              const data = await response.json();
              
              if (!response.ok) {
                throw new Error(data.error || 'Depo oluÅŸturulurken bir hata oluÅŸtu.');
              }
              
              if (data.success) {
                // Close modal
                closeYeniDepoModal();
                
                // Refresh depots table
                if (typeof loadDepotsTable === 'function') {
                  loadDepotsTable();
                }
                
                // Refresh map markers using the centralized function
                if (typeof loadDepotsForMap === 'function') {
                  loadDepotsForMap();
                }
                
                // Show success message (optional)
                console.log('âœ… Depo baÅŸarÄ±yla oluÅŸturuldu:', data);
              }
            } catch (error) {
              console.error('âŒ Depo oluÅŸturma hatasÄ±:', error);
              if (yeniDepoErrorMessage) {
                yeniDepoErrorMessage.textContent = error.message || 'Depo oluÅŸturulurken bir hata oluÅŸtu.';
                yeniDepoErrorMessage.classList.remove('hidden');
              }
            } finally {
              saveBtn.disabled = false;
              saveBtn.innerHTML = originalText;
            }
          });
        }

        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && yeniDepoModal && !yeniDepoModal.classList.contains('hidden')) {
            closeYeniDepoModal();
          }
        });
      });

      // Delete confirmation modal functions
      let pendingDeleteLokasyonId = null;
      
      function showDeleteConfirmation(lokasyonId, depoAd) {
        pendingDeleteLokasyonId = lokasyonId;
        const modal = document.getElementById('delete-depot-modal');
        const message = document.getElementById('delete-depot-message');
        if (message) {
          message.textContent = `"${depoAd}" adlÄ± depo listeden kaldÄ±rÄ±lacak. Geri alÄ±nabilir.`;
        }
        if (modal) {
          modal.classList.remove('hidden');
          if (typeof lockBodyScroll === 'function') {
            lockBodyScroll(true);
          }
        }
      }
      
      function closeDeleteConfirmationModal() {
        pendingDeleteLokasyonId = null;
        const modal = document.getElementById('delete-depot-modal');
        if (modal) {
          modal.classList.add('hidden');
          if (typeof lockBodyScroll === 'function') {
            lockBodyScroll(false);
          }
        }
      }
      
      async function softDeleteDepot(lokasyonId) {
        try {
          const response = await fetch(`/api/depolar/${lokasyonId}/soft-delete`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const data = await response.json();
          
          // Handle both old format (success) and new format (ok)
          const isSuccess = data.ok === true || data.success === true;
          
          if (isSuccess) {
            // Show success message
            showToast(data.message || 'Depo baÅŸarÄ±yla silindi.', 'success');
            
            // Remove marker from map
            if (typeof removeMarker === 'function') {
              removeMarker(lokasyonId);
            }
            
            // Reload depots table
            if (typeof loadDepotsTable === 'function') {
              loadDepotsTable();
            }
            
            // Reload map markers
            if (typeof loadDepotsForMap === 'function') {
              loadDepotsForMap();
            }
          } else {
            // Show error message from server
            const errorMsg = data.message || data.error || 'Depo silinirken bir hata oluÅŸtu.';
            showToast(errorMsg, 'error');
          }
        } catch (error) {
          console.error('âŒ Error soft deleting depot:', error);
          showToast('Depo silinirken bir hata oluÅŸtu: ' + (error.message || 'Bilinmeyen hata'), 'error');
        }
      }
      
      async function markDepotAsOwned(lokasyonId, buttonElement) {
        try {
          const response = await fetch(`/api/depolar/${lokasyonId}/satin-al`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const data = await response.json();
          
          // Handle both old format (success) and new format (ok)
          const isSuccess = data.ok === true || data.success === true;
          
          if (isSuccess) {
            // Show success message
            showToast(data.message || 'Depo satÄ±n alÄ±ndÄ± olarak iÅŸaretlendi.', 'success');
            
            // Update button state
            if (buttonElement) {
              buttonElement.disabled = true;
              buttonElement.classList.add('disabled');
            }
            
            // Update row to show owned badge
            const row = document.querySelector(`tr[data-lokasyon-id="${lokasyonId}"]`);
            if (row) {
              row.dataset.owned = '1';
              const nameCell = row.querySelector('td[data-label="Depo AdÄ±"]');
              if (nameCell && !nameCell.querySelector('.owned-badge')) {
                const nameText = nameCell.querySelector('strong').textContent;
                nameCell.innerHTML = `<strong>${nameText}</strong> <span class="owned-badge">âœ… SatÄ±n AlÄ±ndÄ±</span>`;
              }
            }
            
            // Update marker popup if function exists
            if (typeof updateMarkerPopup === 'function') {
              updateMarkerPopup(lokasyonId, { sahip_miyiz: 1 });
            }
            
            // Refresh owned depots list if modal is open
            const ownedModal = document.getElementById('mevcut-depolarim-modal');
            if (ownedModal && !ownedModal.classList.contains('hidden')) {
              loadOwnedDepots();
            }
            
            // Update allDepotsData to reflect the purchase
            const depotIndex = allDepotsData.findIndex(d => d.lokasyon_id === lokasyonId);
            if (depotIndex !== -1) {
              allDepotsData[depotIndex].sahip_miyiz = 1;
            }
          } else {
            // Show error message from server
            const errorMsg = data.message || data.error || 'Depo gÃ¼ncellenirken bir hata oluÅŸtu.';
            showToast(errorMsg, 'error');
          }
        } catch (error) {
          console.error('âŒ Error marking depot as owned:', error);
          showToast('Depo gÃ¼ncellenirken bir hata oluÅŸtu: ' + (error.message || 'Bilinmeyen hata'), 'error');
        }
      }
      
      // ======================
      // Mevcut DepolarÄ±m Modal Functions
      // ======================
      
      let ownedDepotsData = [];
      
      function openOwnedDepotsModal() {
        const modal = document.getElementById('mevcut-depolarim-modal');
        if (!modal) return;
        
        modal.classList.remove('hidden');
        if (typeof lockBodyScroll === 'function') {
          lockBodyScroll(true);
        } else {
          document.body.style.overflow = 'hidden';
        }
        
        // Load owned depots
        loadOwnedDepots();
      }
      
      function closeOwnedDepotsModal() {
        const modal = document.getElementById('mevcut-depolarim-modal');
        if (modal) {
          modal.classList.add('hidden');
        }
        if (typeof lockBodyScroll === 'function') {
          lockBodyScroll(false);
        } else {
          document.body.style.overflow = '';
        }
      }
      
      async function loadOwnedDepots() {
        const loadingEl = document.getElementById('mevcut-depolarim-loading');
        const contentEl = document.getElementById('mevcut-depolarim-content');
        const emptyEl = document.getElementById('mevcut-depolarim-empty');
        const tbody = document.getElementById('mevcut-depolarim-table-body');
        
        if (!loadingEl || !contentEl || !emptyEl || !tbody) return;
        
        // Show loading (reset display style)
        loadingEl.classList.remove('hidden');
        loadingEl.style.display = '';
        contentEl.classList.add('hidden');
        emptyEl.classList.add('hidden');
        
        try {
          // Fetch depots and locations (which includes used_db)
          const [depotsResponse, locationsResponse] = await Promise.all([
            fetch('/api/depolar-detay'),
            fetch('/api/lokasyonlar')
          ]);
          
          if (!depotsResponse.ok) {
            throw new Error('Depo verileri alÄ±namadÄ±');
          }
          
          const depotsData = await depotsResponse.json();
          let allDepots = [];
          
          if (depotsData.success && depotsData.depolar) {
            allDepots = depotsData.depolar;
          } else if (Array.isArray(depotsData)) {
            allDepots = depotsData;
          }
          
          // Filter only purchased depots: tur='depo' AND sahip_miyiz=1
          let ownedDepots = allDepots.filter(depo => 
            depo.tur === 'depo' && depo.sahip_miyiz === 1
          );
          
          // If locations endpoint is available, merge used_db data
          if (locationsResponse.ok) {
            try {
              const locationsData = await locationsResponse.json();
              if (locationsData.success && locationsData.data) {
                const locationsMap = new Map();
                locationsData.data.forEach(loc => {
                  locationsMap.set(loc.lokasyon_id, loc);
                });
                
                // Merge used_db and compute doluluk_yuzde client-side from used_db and capacity
                ownedDepots = ownedDepots.map(depo => {
                  // Use depot capacity: kapasite_db or kapasite
                  const capDb = Number(depo.kapasite_db ?? depo.kapasite ?? 0);
                  
                  const location = locationsMap.get(depo.lokasyon_id);
                  if (location) {
                    // If location exists, use usedDb from location
                    const usedDb = Number(location.used_db ?? 0);
                    const doluluk = capDb > 0 ? (usedDb / capDb) * 100 : 0;
                    return {
                      ...depo,
                      used_db: usedDb,
                      doluluk_yuzde: doluluk
                    };
                  } else {
                    // If location does not exist, compute fallback from depot's own used field
                    const usedFallback = Number(depo.used_db ?? depo.kullanilan_db ?? depo.kullanilan ?? 0);
                    const dolulukFallback = capDb > 0 ? (usedFallback / capDb) * 100 : 0;
                    return {
                      ...depo,
                      used_db: usedFallback,
                      doluluk_yuzde: dolulukFallback
                    };
                  }
                });
              }
            } catch (locError) {
              console.warn('âš ï¸ Could not load location occupancy data:', locError);
            }
          }
          
          ownedDepotsData = ownedDepots;
          
          // Hide loading completely (doesn't take up space)
          loadingEl.classList.add('hidden');
          loadingEl.style.display = 'none';
          
          // Show content area
          contentEl.classList.remove('hidden');
          
          if (ownedDepotsData.length === 0) {
            // Show empty state, hide table
            emptyEl.classList.remove('hidden');
            tbody.innerHTML = '';
          } else {
            // Hide empty state, render table
            emptyEl.classList.add('hidden');
            renderOwnedDepotsList(ownedDepotsData);
          }
        } catch (error) {
          console.error('âŒ Error loading owned depots:', error);
          // Hide loading completely
          loadingEl.classList.add('hidden');
          loadingEl.style.display = 'none';
          // Show content area with error
          contentEl.classList.remove('hidden');
          emptyEl.classList.remove('hidden');
          emptyEl.innerHTML = '<p style="color: var(--color-danger);">Depo verileri yÃ¼klenirken bir hata oluÅŸtu.</p>';
          tbody.innerHTML = '';
        }
      }
      
      function renderOwnedDepotsList(depots) {
        const tbody = document.getElementById('mevcut-depolarim-table-body');
        if (!tbody) return;
        
        if (depots.length === 0) {
          tbody.innerHTML = '';
          return;
        }
        
        tbody.innerHTML = depots.map(depo => {
          const distance = depo.distance_km !== null ? formatNumber(depo.distance_km) + ' km' : '-';
          const rent = formatCurrency(depo.aylik_kira);
          const capacity = formatNumber(depo.kapasite_db || depo.kullanilabilir_kapasite_db);
          const area = depo.metrekare ? formatNumber(depo.metrekare) + ' mÂ²' : '-';
          const height = depo.yukseklik_m ? formatNumber(depo.yukseklik_m) + ' m' : '-';
          const address = depo.adres || '-';
          
          // Use computed doluluk_yuzde from merged data (0-100 scale)
          const dolulukYuzde = Number(depo.doluluk_yuzde ?? 0);
          const usedDb = Number(depo.used_db ?? 0);
          
          // Display occupancy percentage with 1 decimal
          let occupancyPercent = '-';
          let occupancyClass = '';
          let statusBadge = '';
          
          if (!isNaN(dolulukYuzde) && dolulukYuzde >= 0) {
            occupancyPercent = dolulukYuzde.toFixed(1) + '%';
            
            // Status badge: Kritik if >= 80%, else Normal
            // Use the doluluk_yuzde value (0-100 scale) for comparison
            if (dolulukYuzde >= 80) {
              statusBadge = '<span class="status-badge status-badge-critical">Kritik</span>';
              occupancyClass = 'occupancy-critical';
            } else {
              statusBadge = '<span class="status-badge status-badge-normal">Normal</span>';
              occupancyClass = 'occupancy-normal';
            }
          } else {
            // Invalid or missing occupancy, show dash and Normal status
            occupancyPercent = '-';
            statusBadge = '<span class="status-badge status-badge-normal">Normal</span>';
          }
          
          const usedDbFormatted = formatNumber(usedDb);
          
          // Photo thumbnail
          const photos = depo.photos || [];
          const firstPhoto = photos.length > 0 ? photos[0].foto_url : null;
          const photoThumbnail = firstPhoto 
            ? `<button type="button" class="depo-thumbnail-btn" data-lokasyon-id="${depo.lokasyon_id}" data-photos='${JSON.stringify(photos)}' aria-label="FotoÄŸraflarÄ± gÃ¶rÃ¼ntÃ¼le"><img src="${firstPhoto}" alt="${depo.ad || 'Depo'}" class="depo-thumbnail" /></button>`
            : '<div class="depo-thumbnail-placeholder">ğŸ“·</div>';
          
          return `
            <tr data-lokasyon-id="${depo.lokasyon_id}">
              <td data-label="FotoÄŸraf" class="photo-cell">${photoThumbnail}</td>
              <td data-label="Depo AdÄ±"><strong>${depo.ad || 'Depo'}</strong></td>
              <td data-label="Mesafe">${distance}</td>
              <td data-label="AylÄ±k Kira">${rent}</td>
              <td data-label="Kapasite (DB)">${capacity}</td>
              <td data-label="KullanÄ±lan (DB)">${usedDbFormatted}</td>
              <td data-label="Doluluk OranÄ±" class="${occupancyClass}">${occupancyPercent}</td>
              <td data-label="Durum">${statusBadge}</td>
              <td data-label="Metrekare">${area}</td>
              <td data-label="YÃ¼kseklik">${height}</td>
              <td data-label="Adres" class="address-cell">${address}</td>
            </tr>
          `;
        }).join('');
        
        // Add click handlers to photo thumbnails
        tbody.querySelectorAll('.depo-thumbnail-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            const photos = JSON.parse(this.dataset.photos || '[]');
            const lokasyonId = this.dataset.lokasyonId;
            const depoName = this.closest('tr').querySelector('td[data-label="Depo AdÄ±"] strong').textContent;
            if (typeof openPhotoModal === 'function') {
              openPhotoModal(photos, lokasyonId, depoName);
            }
          });
        });
      }
      
      // Simple toast notification function
      function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 24px;
          background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
          color: white;
          border-radius: 8px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          z-index: 10000;
          animation: slideIn 0.3s ease-out;
        `;
        
        document.body.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }
      
      function logout() {
        // Hem sessionStorage hem localStorage temizle (her ihtimale karÅŸÄ±)
        sessionStorage.removeItem('liderElektrikLoggedIn');
        localStorage.removeItem('liderElektrikLoggedIn');
        // Redirect to login page
        window.location.href = '/login.html';
      }
      
      // Delete confirmation modal event listeners
      document.addEventListener('DOMContentLoaded', function() {
        const deleteModal = document.getElementById('delete-depot-modal');
        const deleteModalBackdrop = document.getElementById('delete-depot-modal-backdrop');
        const deleteModalClose = document.getElementById('delete-depot-modal-close-btn');
        const deleteCancelBtn = document.getElementById('delete-depot-cancel-btn');
        const deleteConfirmBtn = document.getElementById('delete-depot-confirm-btn');
        
        if (deleteModalBackdrop) {
          deleteModalBackdrop.addEventListener('click', closeDeleteConfirmationModal);
        }
        if (deleteModalClose) {
          deleteModalClose.addEventListener('click', closeDeleteConfirmationModal);
        }
        if (deleteCancelBtn) {
          deleteCancelBtn.addEventListener('click', closeDeleteConfirmationModal);
        }
        if (deleteConfirmBtn) {
          deleteConfirmBtn.addEventListener('click', async function() {
            if (pendingDeleteLokasyonId) {
              await softDeleteDepot(pendingDeleteLokasyonId);
              closeDeleteConfirmationModal();
            }
          });
        }
        
        // ESC key to close delete modal
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && deleteModal && !deleteModal.classList.contains('hidden')) {
            closeDeleteConfirmationModal();
          }
        });
      });
    </script>
</body>
</html>

